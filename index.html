<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dog Walker Pro - Cloud Sync</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, doc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ConfiguraciÃ³n proporcionada por el entorno
        const firebaseConfig = JSON.parse(__firebase_config);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Variables de estado global
        let user = null;
        let walks = [];

        // --- INICIO DE AUTH ---
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Error de autenticaciÃ³n:", error);
            }
        };

        onAuthStateChanged(auth, (u) => {
            user = u;
            if (user) {
                setupRealtimeSync();
            }
        });

        initAuth();

        // --- SINCRONIZACIÃ“N EN TIEMPO REAL ---
        function setupRealtimeSync() {
            if (!user) return;
            // IMPORTANTE: Ruta de Firestore siguiendo la Regla 1
            const walksCol = collection(db, 'artifacts', appId, 'public', 'data', 'walks');
            
            // Escuchar cambios (esto actualiza la app solita si alguien sube algo en otro cel)
            onSnapshot(walksCol, (snapshot) => {
                walks = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                })).sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                
                renderHistory();
            }, (error) => {
                console.error("Error sincronizando datos:", error);
            });
        }

        // --- COMPRESIÃ“N DE IMAGEN (Para que el botÃ³n de confirmar no se trabe) ---
        async function compressImage(base64Str) {
            return new Promise((resolve) => {
                const img = new Image();
                img.src = base64Str;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 800;
                    const MAX_HEIGHT = 800;
                    let width = img.width;
                    let height = img.height;

                    if (width > height) {
                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }
                    } else {
                        if (height > MAX_HEIGHT) {
                            width *= MAX_HEIGHT / height;
                            height = MAX_HEIGHT;
                        }
                    }
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', 0.7)); // Comprimir al 70%
                };
            });
        }

        // --- FUNCIONES DE LA UI ---
        window.saveWalk = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            const noteInput = document.getElementById('noteInput');
            const previewImg = document.getElementById('imagePreview');
            
            if (!user) {
                alert("Espera un momento, estamos conectando con la nube...");
                return;
            }

            try {
                btn.disabled = true;
                btn.innerText = "Subiendo a la nube...";

                const compressedImg = await compressImage(previewImg.src);
                const now = new Date();
                
                const walksCol = collection(db, 'artifacts', appId, 'public', 'data', 'walks');
                await addDoc(walksCol, {
                    dateDisplay: now.toLocaleDateString('es-MX', { weekday: 'long', day: 'numeric', month: 'long' }),
                    timeDisplay: now.toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' }),
                    image: compressedImg,
                    note: noteInput.value || "Â¡Paseo completado!",
                    userId: user.uid,
                    createdAt: serverTimestamp()
                });

                // Resetear form
                document.getElementById('dogWalkForm').reset();
                document.getElementById('previewContainer').classList.add('hidden');
                document.getElementById('uploadPrompt').classList.remove('hidden');
                document.getElementById('uploadForm').classList.add('hidden');
                document.getElementById('plusIcon').style.transform = 'rotate(0deg)';
                switchTab('history');
                
            } catch (err) {
                console.error(err);
                alert("Hubo un error al guardar. Intenta de nuevo.");
            } finally {
                btn.disabled = false;
                btn.innerText = "Confirmar Paseo";
            }
        };

        window.deleteWalk = async (id) => {
            if (!confirm("Â¿Borrar este registro?")) return;
            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'walks', id);
                await deleteDoc(docRef);
            } catch (err) {
                console.error(err);
            }
        };

        // --- RENDERIZADO ---
        function renderHistory() {
            const container = document.getElementById('walksHistory');
            if (walks.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-20 bg-white rounded-[2rem] border border-dashed border-slate-300">
                        <i data-lucide="dog" class="w-12 h-12 text-slate-200 mx-auto mb-2"></i>
                        <p class="text-slate-400">Sin registros en la nube.</p>
                    </div>
                `;
            } else {
                container.innerHTML = walks.map(walk => `
                    <article class="bg-white rounded-[2rem] overflow-hidden shadow-md border border-slate-100 animate-in fade-in slide-in-from-bottom-2">
                        <div class="relative h-72">
                            <img src="${walk.image}" class="w-full h-full object-cover">
                            <div class="absolute bottom-4 left-4 right-4 flex justify-between items-end">
                                <div class="bg-white/90 backdrop-blur-md p-3 rounded-2xl shadow-lg">
                                    <p class="text-[10px] font-bold text-orange-600 uppercase tracking-widest">${walk.dateDisplay}</p>
                                    <div class="flex items-center gap-1 text-slate-800">
                                        <i data-lucide="clock" class="w-3 h-3 text-orange-500"></i>
                                        <span class="text-lg font-black">${walk.timeDisplay}</span>
                                    </div>
                                </div>
                                <button onclick="deleteWalk('${walk.id}')" class="bg-red-500 text-white p-3 rounded-xl shadow-lg active:scale-90">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                        <div class="p-4 bg-white">
                            <p class="text-slate-700 font-medium italic">"${walk.note}"</p>
                        </div>
                    </article>
                `).join('');
            }
            lucide.createIcons();
        }

        // --- NAVEGACIÃ“N Y EVENTOS ---
        function switchTab(tab) {
            const schedSection = document.getElementById('scheduleSection');
            const histSection = document.getElementById('historySection');
            const tabSched = document.getElementById('tabSchedule');
            const tabHist = document.getElementById('tabHistory');

            if (tab === 'schedule') {
                schedSection.classList.remove('hidden');
                histSection.classList.add('hidden');
                tabSched.className = 'tab-active flex items-center gap-2 px-6 py-3 rounded-2xl transition-all';
                tabHist.className = 'tab-inactive flex items-center gap-2 px-6 py-3 rounded-2xl transition-all';
            } else {
                schedSection.classList.add('hidden');
                histSection.classList.remove('hidden');
                tabSched.className = 'tab-inactive flex items-center gap-2 px-6 py-3 rounded-2xl transition-all';
                tabHist.className = 'tab-active flex items-center gap-2 px-6 py-3 rounded-2xl transition-all';
            }
        }

        window.onload = () => {
            lucide.createIcons();
            
            // Tablas de horario (estÃ¡ticas)
            const schedule = {
                weekdays: [{t:"10:00 AM", p:"Itzel"}, {t:"03:00 PM", p:"Gael"}, {t:"09:30 PM", p:"Montse"}],
                sat: [{t:"10:00 AM", p:"Itzel"}, {t:"03:00 PM", p:"Gael"}, {t:"09:30 PM", p:"Montse"}],
                sun: [{t:"09:00 AM", p:"Gael"}, {t:"09-11 AM", p:"Entreno"}, {t:"2-4 PM", p:"Itzel"}, {t:"08:00 PM", p:"Montse"}]
            };

            const fillTable = (data, id) => {
                document.getElementById(id).innerHTML = data.map(i => `
                    <div class="flex items-center justify-between p-4 border-b border-orange-50 last:border-0">
                        <div class="flex items-center gap-3">
                            <i data-lucide="clock" class="w-4 h-4 text-blue-400"></i>
                            <span class="font-bold text-slate-800">${i.t}</span>
                        </div>
                        <span class="px-3 py-1 bg-white border border-slate-200 rounded-full text-sm font-semibold text-orange-600">${i.p}</span>
                    </div>
                `).join('');
            };
            fillTable(schedule.weekdays, 'weekdaysList');
            fillTable(schedule.sat, 'saturdayList');
            fillTable(schedule.sun, 'sundayList');

            // Eventos UI
            document.getElementById('tabSchedule').onclick = () => switchTab('schedule');
            document.getElementById('tabHistory').onclick = () => switchTab('history');
            document.getElementById('toggleFormBtn').onclick = () => {
                const form = document.getElementById('uploadForm');
                form.classList.toggle('hidden');
                document.getElementById('plusIcon').style.transform = form.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(45deg)';
            };
            document.getElementById('fileInput').onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        document.getElementById('imagePreview').src = ev.target.result;
                        document.getElementById('previewContainer').classList.remove('hidden');
                        document.getElementById('uploadPrompt').classList.add('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            };
            document.getElementById('dogWalkForm').onsubmit = window.saveWalk;
            lucide.createIcons();
        };
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        .tab-active { @apply bg-orange-500 text-white shadow-lg shadow-orange-200 scale-105; }
        .tab-inactive { @apply text-slate-500 hover:bg-slate-100; }
        .hidden { display: none; }
    </style>
</head>
<body class="bg-orange-50 text-slate-800 pb-24 min-h-screen">

    <header class="bg-white border-b border-orange-100 sticky top-0 z-20 p-4 shadow-sm">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="bg-orange-500 p-2 rounded-xl">
                    <i data-lucide="dog" class="text-white w-6 h-6"></i>
                </div>
                <h1 class="text-xl font-bold text-slate-900">Dog Walker Cloud</h1>
            </div>
            <button id="toggleFormBtn" class="p-3 rounded-2xl bg-orange-500 text-white shadow-md active:scale-90 transition-transform">
                <i data-lucide="plus" id="plusIcon" class="w-5 h-5 transition-transform"></i>
            </button>
        </div>
    </header>

    <main class="max-w-md mx-auto p-4">
        
        <!-- Formulario -->
        <div id="uploadForm" class="hidden bg-white rounded-3xl shadow-2xl p-6 mb-8 border border-orange-100">
            <h2 class="text-lg font-bold mb-4 flex items-center gap-2">ðŸ“¸ Nuevo Paseo</h2>
            <form id="dogWalkForm" class="space-y-4">
                <div class="relative group">
                    <div id="dropzone" class="w-full h-56 rounded-2xl border-2 border-dashed border-slate-300 bg-slate-50 flex flex-col items-center justify-center overflow-hidden">
                        <div id="previewContainer" class="hidden w-full h-full">
                            <img id="imagePreview" src="" alt="Preview" class="w-full h-full object-cover">
                        </div>
                        <div id="uploadPrompt" class="flex flex-col items-center">
                            <i data-lucide="camera" class="text-orange-500 w-8 h-8 mb-2"></i>
                            <p class="text-sm font-medium text-slate-600">Subir foto del paseo</p>
                        </div>
                    </div>
                    <input type="file" id="fileInput" accept="image/*" capture="environment" class="absolute inset-0 opacity-0 cursor-pointer" required>
                </div>
                <input type="text" id="noteInput" placeholder="Â¿QuiÃ©n lo sacÃ³ o algÃºn detalle?" class="w-full px-4 py-4 rounded-xl bg-slate-50 border border-slate-200 outline-none">
                <button type="submit" id="submitBtn" class="w-full bg-orange-600 text-white font-bold py-4 rounded-2xl shadow-lg active:scale-95 disabled:bg-slate-400">
                    Confirmar Paseo
                </button>
            </form>
        </div>

        <!-- Secciones -->
        <div id="scheduleSection" class="space-y-6">
            <div class="bg-white rounded-[2rem] shadow-sm border border-orange-100 overflow-hidden">
                <div class="bg-orange-500 p-4 text-white font-bold flex items-center gap-2"><i data-lucide="calendar"></i> Lunes-Viernes</div>
                <div id="weekdaysList"></div>
            </div>
            <div class="bg-white rounded-[2rem] shadow-sm border border-orange-100 overflow-hidden">
                <div class="bg-slate-800 p-4 text-white font-bold flex items-center gap-2"><i data-lucide="calendar"></i> SÃ¡bados</div>
                <div id="saturdayList"></div>
            </div>
            <div class="bg-white rounded-[2rem] shadow-sm border border-orange-100 overflow-hidden">
                <div class="bg-purple-600 p-4 text-white font-bold flex items-center gap-2"><i data-lucide="calendar"></i> Domingos</div>
                <div id="sundayList"></div>
            </div>
        </div>

        <div id="historySection" class="hidden space-y-6">
            <div id="walksHistory" class="space-y-6"></div>
        </div>
    </main>

    <nav class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-white/90 backdrop-blur-xl border border-slate-200 px-2 py-2 rounded-3xl shadow-2xl flex gap-2 z-30">
        <button id="tabSchedule" class="tab-active flex items-center gap-2 px-6 py-3 rounded-2xl">
            <i data-lucide="calendar" class="w-5 h-5"></i><span class="font-bold text-sm">Horarios</span>
        </button>
        <button id="tabHistory" class="tab-inactive flex items-center gap-2 px-6 py-3 rounded-2xl">
            <i data-lucide="list" class="w-5 h-5"></i><span class="font-bold text-sm">Historial</span>
        </button>
    </nav>

</body>
</html>
