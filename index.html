<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dog Tracker - Instant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        .tab-active { @apply bg-orange-500 text-white shadow-lg scale-105; }
        .tab-inactive { @apply text-slate-500 hover:bg-slate-100; }
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }
        /* Efecto de carga en miniatura */
        .uploading-pulse { animation: pulse 1.5s infinite; opacity: 0.6; }
        @keyframes pulse { 0% { opacity: 0.4; } 50% { opacity: 0.7; } 100% { opacity: 0.4; } }
    </style>
</head>
<body class="bg-orange-50 text-slate-800 pb-32 min-h-screen">

    <header class="bg-white border-b border-orange-100 sticky top-0 z-20 p-4 shadow-sm">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="bg-orange-500 p-2 rounded-xl shadow-md">
                    <i data-lucide="dog" class="text-white w-6 h-6"></i>
                </div>
                <h1 class="text-xl font-extrabold text-slate-900 tracking-tight">Dog Tracker</h1>
            </div>
            <button id="toggleFormBtn" class="p-3 rounded-2xl bg-orange-500 text-white shadow-lg active:scale-90 transition-all">
                <i data-lucide="plus" id="plusIcon" class="w-6 h-6 transition-transform"></i>
            </button>
        </div>
    </header>

    <main class="max-w-md mx-auto p-4">
        
        <!-- Formulario Optimista -->
        <div id="uploadForm" class="hidden bg-white rounded-3xl shadow-2xl p-6 mb-8 border border-orange-100 fade-in">
            <h2 class="text-lg font-bold mb-4 flex items-center gap-2">üì∏ Nuevo Paseo</h2>
            <form id="dogWalkForm" class="space-y-4">
                <div class="relative group">
                    <div id="dropzone" class="w-full h-48 rounded-2xl border-2 border-dashed border-slate-300 bg-slate-50 flex flex-col items-center justify-center overflow-hidden">
                        <div id="previewContainer" class="hidden w-full h-full">
                            <img id="imagePreview" src="" alt="Preview" class="w-full h-full object-cover">
                        </div>
                        <div id="uploadPrompt" class="flex flex-col items-center p-4">
                            <i data-lucide="camera" class="text-orange-500 w-10 h-10 mb-2"></i>
                            <p class="text-sm font-bold text-slate-600">Click para foto</p>
                        </div>
                    </div>
                    <input type="file" id="fileInput" accept="image/*" capture="environment" class="absolute inset-0 opacity-0 cursor-pointer" required>
                </div>
                <input type="text" id="noteInput" placeholder="¬øQui√©n fue?" class="w-full px-5 py-4 rounded-xl bg-slate-50 border border-slate-200 outline-none">
                <button type="submit" id="submitBtn" class="w-full bg-orange-600 text-white font-black py-4 rounded-2xl shadow-lg active:scale-95 text-lg">
                    CONFIRMAR
                </button>
            </form>
        </div>

        <!-- Horarios -->
        <div id="scheduleSection" class="space-y-6 fade-in">
            <div class="bg-white rounded-[2rem] shadow-sm border border-orange-100 overflow-hidden">
                <div class="bg-orange-500 p-4 text-white font-bold flex items-center gap-2"><i data-lucide="calendar"></i> Lun-Vie</div>
                <div id="weekdaysList" class="divide-y divide-orange-50"></div>
            </div>
            <div class="bg-white rounded-[2.5rem] shadow-sm border border-orange-100 overflow-hidden">
                <div class="bg-slate-800 p-4 text-white font-bold flex items-center gap-2"><i data-lucide="calendar"></i> S√°bados</div>
                <div id="saturdayList" class="divide-y divide-orange-50"></div>
            </div>
            <div class="bg-white rounded-[2.5rem] shadow-sm border border-orange-100 overflow-hidden">
                <div class="bg-purple-600 p-4 text-white font-bold flex items-center gap-2"><i data-lucide="award"></i> Domingos</div>
                <div id="sundayList" class="divide-y divide-orange-50"></div>
            </div>
        </div>

        <div id="historySection" class="hidden space-y-6 fade-in">
            <div id="walksHistory" class="space-y-6"></div>
        </div>
    </main>

    <!-- Navegaci√≥n -->
    <nav class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-white/95 backdrop-blur-xl border border-slate-200 p-2 rounded-[2rem] shadow-2xl flex gap-2 z-30">
        <button id="tabSchedule" class="tab-active flex items-center gap-2 px-8 py-4 rounded-3xl transition-all">
            <i data-lucide="calendar" class="w-5 h-5"></i>
            <span class="font-bold text-sm">Horarios</span>
        </button>
        <button id="tabHistory" class="tab-inactive flex items-center gap-2 px-8 py-4 rounded-3xl transition-all">
            <i data-lucide="list" class="w-5 h-5"></i>
            <span class="font-bold text-sm">Fotos</span>
        </button>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 1. HORARIOS
        const sched = {
            wv: [{t:"10:00 AM", p:"Itzel"}, {t:"03:00 PM", p:"Gael"}, {t:"09:30 PM", p:"Montse"}],
            sa: [{t:"10:00 AM", p:"Itzel"}, {t:"03:00 PM", p:"Gael"}, {t:"09:30 PM", p:"Montse"}],
            su: [{t:"09:00 AM", p:"Gael"}, {t:"09-11 AM", p:"Entreno"}, {t:"02-04 PM", p:"Itzel"}, {t:"08:00 PM", p:"Montse"}]
        };

        function renderSched() {
            const f = (d, id) => document.getElementById(id).innerHTML = d.map(i => `
                <div class="flex items-center justify-between p-4 active:bg-orange-50">
                    <div class="flex items-center gap-3">
                        <i data-lucide="clock" class="w-4 h-4 text-blue-400"></i>
                        <span class="font-bold text-slate-800">${i.t}</span>
                    </div>
                    <span class="px-3 py-1 bg-white border border-orange-100 rounded-xl text-xs font-black text-orange-600 shadow-sm">${i.p}</span>
                </div>
            `).join('');
            f(sched.wv, 'weekdaysList'); f(sched.sa, 'saturdayList'); f(sched.su, 'sundayList');
            lucide.createIcons();
        }
        renderSched();

        // 2. CLOUD
        let db, user, walks = [];
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        async function init() {
            try {
                const config = JSON.parse(__firebase_config);
                const app = initializeApp(config);
                const auth = getAuth(app);
                db = getFirestore(app);
                await signInAnonymously(auth);
                onAuthStateChanged(auth, (u) => {
                    user = u;
                    if (user) onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'walks'), (s) => {
                        walks = s.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                        renderHistory();
                    });
                });
            } catch (e) {}
        }

        // 3. COMPRESI√ìN INSTANT√ÅNEA
        async function compress(b64) {
            return new Promise((res) => {
                const img = new Image();
                img.src = b64;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX = 300; // Miniatura de 300px
                    const s = Math.min(MAX/img.width, MAX/img.height, 1);
                    canvas.width = img.width*s; canvas.height = img.height*s;
                    canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
                    res(canvas.toDataURL('image/jpeg', 0.2)); // Calidad m√≠nima para velocidad m√°xima
                };
            });
        }

        window.handleSave = async (e) => {
            e.preventDefault();
            const preview = document.getElementById('imagePreview').src;
            const note = document.getElementById('noteInput').value || "Listo";
            
            // --- ACCI√ìN INSTANT√ÅNEA (NO ESPERAMOS) ---
            document.getElementById('dogWalkForm').reset();
            document.getElementById('uploadForm').classList.add('hidden');
            document.getElementById('previewContainer').classList.add('hidden');
            document.getElementById('uploadPrompt').classList.remove('hidden');
            switchTab('history');

            // --- PROCESO EN SEGUNDO PLANO ---
            try {
                const mini = await compress(preview);
                const now = new Date();
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'walks'), {
                    image: mini, note, 
                    dateDisplay: now.toLocaleDateString('es-MX', { day: 'numeric', month: 'short' }),
                    timeDisplay: now.toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' }),
                    createdAt: serverTimestamp()
                });
            } catch (err) { console.error(err); }
        };

        function renderHistory() {
            const c = document.getElementById('walksHistory');
            c.innerHTML = walks.length === 0 ? '<div class="text-center py-20 text-slate-400">Sin fotos.</div>' : walks.map(w => `
                <div class="bg-white rounded-[2rem] overflow-hidden shadow-sm border border-slate-100 fade-in">
                    <div class="relative h-64">
                        <img src="${w.image}" class="w-full h-full object-cover">
                        <div class="absolute bottom-3 left-3 right-3 flex justify-between items-end">
                            <div class="bg-white/95 p-2 px-3 rounded-xl shadow-lg">
                                <p class="text-[10px] font-bold text-orange-600 uppercase">${w.dateDisplay}</p>
                                <p class="text-lg font-black">${w.timeDisplay}</p>
                            </div>
                            <button onclick="window.delWalk('${w.id}')" class="bg-red-500 text-white p-3 rounded-xl active:scale-75"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                    <div class="p-4 font-bold text-slate-700 italic text-sm">"${w.note}"</div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        window.delWalk = async (id) => { if(confirm("¬øBorrar?")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'walks', id)); };

        function switchTab(t) {
            document.getElementById('scheduleSection').classList.toggle('hidden', t !== 'schedule');
            document.getElementById('historySection').classList.toggle('hidden', t !== 'history');
            document.getElementById('tabSchedule').className = t === 'schedule' ? 'tab-active flex items-center gap-2 px-8 py-4 rounded-3xl' : 'tab-inactive flex items-center gap-2 px-8 py-4 rounded-3xl';
            document.getElementById('tabHistory').className = t === 'history' ? 'tab-active flex items-center gap-2 px-8 py-4 rounded-3xl' : 'tab-inactive flex items-center gap-2 px-8 py-4 rounded-3xl';
            window.scrollTo(0,0);
        }

        document.getElementById('tabSchedule').onclick = () => switchTab('schedule');
        document.getElementById('tabHistory').onclick = () => switchTab('history');
        document.getElementById('toggleFormBtn').onclick = () => document.getElementById('uploadForm').classList.toggle('hidden');
        document.getElementById('fileInput').onchange = (e) => {
            const r = new FileReader();
            r.onload = (ev) => {
                document.getElementById('imagePreview').src = ev.target.result;
                document.getElementById('previewContainer').classList.remove('hidden');
                document.getElementById('uploadPrompt').classList.add('hidden');
            };
            r.readAsDataURL(e.target.files[0]);
        };
        document.getElementById('dogWalkForm').onsubmit = window.handleSave;

        init();
    </script>
</body>
</html>
