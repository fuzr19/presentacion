<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dog Walker Pro - Cloud Sync</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        .tab-active { @apply bg-orange-500 text-white shadow-lg shadow-orange-200 scale-105; }
        .tab-inactive { @apply text-slate-500 hover:bg-slate-100; }
        .hidden { display: none !important; }
        /* Animaci贸n suave para la carga */
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-orange-50 text-slate-800 pb-28 min-h-screen">

    <header class="bg-white border-b border-orange-100 sticky top-0 z-20 p-4 shadow-sm">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="bg-orange-500 p-2 rounded-xl">
                    <i data-lucide="dog" class="text-white w-6 h-6"></i>
                </div>
                <h1 class="text-xl font-bold text-slate-900">Dog Walker Cloud</h1>
            </div>
            <button id="toggleFormBtn" class="p-3 rounded-2xl bg-orange-500 text-white shadow-md active:scale-90 transition-transform">
                <i data-lucide="plus" id="plusIcon" class="w-6 h-6 transition-transform"></i>
            </button>
        </div>
    </header>

    <main class="max-w-md mx-auto p-4">
        
        <!-- Formulario para subir paseos -->
        <div id="uploadForm" class="hidden bg-white rounded-3xl shadow-2xl p-6 mb-8 border border-orange-100 fade-in">
            <h2 class="text-lg font-bold mb-4 flex items-center gap-2"> Registrar Paseo</h2>
            <form id="dogWalkForm" class="space-y-4">
                <div class="relative group">
                    <div id="dropzone" class="w-full h-56 rounded-2xl border-2 border-dashed border-slate-300 bg-slate-50 flex flex-col items-center justify-center overflow-hidden">
                        <div id="previewContainer" class="hidden w-full h-full">
                            <img id="imagePreview" src="" alt="Preview" class="w-full h-full object-cover">
                        </div>
                        <div id="uploadPrompt" class="flex flex-col items-center p-4 text-center">
                            <i data-lucide="camera" class="text-orange-500 w-10 h-10 mb-2"></i>
                            <p class="text-sm font-bold text-slate-600">Toca para tomar foto</p>
                            <p class="text-xs text-slate-400 mt-1">Se guardar谩 fecha y hora autom谩ticamente</p>
                        </div>
                    </div>
                    <input type="file" id="fileInput" accept="image/*" capture="environment" class="absolute inset-0 opacity-0 cursor-pointer" required>
                </div>
                <input type="text" id="noteInput" placeholder="驴Qui茅n lo sac贸?" class="w-full px-4 py-4 rounded-xl bg-slate-50 border border-slate-200 outline-none focus:border-orange-500">
                <button type="submit" id="submitBtn" class="w-full bg-orange-600 text-white font-bold py-5 rounded-2xl shadow-lg active:scale-95 disabled:bg-slate-400 text-lg">
                    Confirmar Paseo
                </button>
            </form>
        </div>

        <!-- Secci贸n de Horarios -->
        <div id="scheduleSection" class="space-y-6 fade-in">
            <div class="bg-white rounded-[2rem] shadow-sm border border-orange-100 overflow-hidden">
                <div class="bg-orange-500 p-4 text-white font-bold flex items-center gap-2">
                    <i data-lucide="calendar"></i> Lunes a Viernes
                </div>
                <div id="weekdaysList" class="divide-y divide-orange-50"></div>
            </div>

            <div class="bg-white rounded-[2rem] shadow-sm border border-orange-100 overflow-hidden">
                <div class="bg-slate-800 p-4 text-white font-bold flex items-center gap-2">
                    <i data-lucide="calendar"></i> S谩bados
                </div>
                <div id="saturdayList" class="divide-y divide-orange-50"></div>
            </div>

            <div class="bg-white rounded-[2rem] shadow-sm border border-orange-100 overflow-hidden">
                <div class="bg-purple-600 p-4 text-white font-bold flex items-center gap-2">
                    <i data-lucide="award"></i> Domingos
                </div>
                <div id="sundayList" class="divide-y divide-orange-50"></div>
            </div>
        </div>

        <!-- Secci贸n de Historial -->
        <div id="historySection" class="hidden space-y-6 fade-in">
            <div id="walksHistory" class="space-y-6">
                <!-- Los paseos de la nube cargan aqu铆 -->
            </div>
        </div>
    </main>

    <!-- Navegaci贸n Inferior -->
    <nav class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-white/90 backdrop-blur-xl border border-slate-200 px-2 py-2 rounded-3xl shadow-2xl flex gap-2 z-30">
        <button id="tabSchedule" class="tab-active flex items-center gap-2 px-6 py-4 rounded-2xl transition-all">
            <i data-lucide="calendar" class="w-5 h-5"></i>
            <span class="font-bold text-sm">Horarios</span>
        </button>
        <button id="tabHistory" class="tab-inactive flex items-center gap-2 px-6 py-4 rounded-2xl transition-all">
            <i data-lucide="list" class="w-5 h-5"></i>
            <span class="font-bold text-sm">Historial</span>
        </button>
    </nav>

    <!-- Firebase y L贸gica -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, doc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuraci贸n de la App
        const firebaseConfig = JSON.parse(__firebase_config);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let user = null;
        let walks = [];

        // 1. Mostrar Horarios Inmediatamente
        const scheduleData = {
            weekdays: [{t:"10:00 AM", p:"Itzel"}, {t:"03:00 PM", p:"Gael"}, {t:"09:30 PM", p:"Montse"}],
            sat: [{t:"10:00 AM", p:"Itzel"}, {t:"03:00 PM", p:"Gael"}, {t:"09:30 PM", p:"Montse"}],
            sun: [{t:"09:00 AM", p:"Gael"}, {t:"09-11 AM", p:"Entreno"}, {t:"02-04 PM", p:"Itzel"}, {t:"08:00 PM", p:"Montse"}]
        };

        function renderStaticSchedules() {
            const fill = (data, id) => {
                document.getElementById(id).innerHTML = data.map(i => `
                    <div class="flex items-center justify-between p-5 hover:bg-orange-50/50">
                        <div class="flex items-center gap-3">
                            <i data-lucide="clock" class="w-5 h-5 text-blue-400"></i>
                            <span class="font-bold text-slate-800 text-lg">${i.t}</span>
                        </div>
                        <span class="px-4 py-1.5 bg-orange-50 border border-orange-100 rounded-full text-sm font-bold text-orange-600">${i.p}</span>
                    </div>
                `).join('');
            };
            fill(scheduleData.weekdays, 'weekdaysList');
            fill(scheduleData.sat, 'saturdayList');
            fill(scheduleData.sun, 'sundayList');
            lucide.createIcons();
        }

        // 2. Autenticaci贸n y Sincronizaci贸n
        async function startApp() {
            renderStaticSchedules();
            
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (e) { console.error("Auth error", e); }

            onAuthStateChanged(auth, (u) => {
                user = u;
                if (user) syncData();
            });
        }

        function syncData() {
            const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'walks');
            onSnapshot(colRef, (snap) => {
                walks = snap.docs.map(d => ({id: d.id, ...d.data()}))
                    .sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                renderHistory();
            });
        }

        // 3. Funciones de Imagen y Guardado
        async function compressImage(base64) {
            return new Promise((res) => {
                const img = new Image();
                img.src = base64;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const scale = Math.min(800 / img.width, 800 / img.height, 1);
                    canvas.width = img.width * scale;
                    canvas.height = img.height * scale;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    res(canvas.toDataURL('image/jpeg', 0.6)); // Comprimir al 60% para que sea r谩pido
                };
            });
        }

        window.handleSave = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            const preview = document.getElementById('imagePreview');
            const note = document.getElementById('noteInput');

            if (!user) return alert("Conectando con la nube...");
            
            try {
                btn.disabled = true;
                btn.innerText = "Subiendo...";
                
                const compressed = await compressImage(preview.src);
                const now = new Date();
                
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'walks'), {
                    image: compressed,
                    note: note.value || "Paseo listo",
                    dateDisplay: now.toLocaleDateString('es-MX', { weekday: 'short', day: 'numeric', month: 'short' }),
                    timeDisplay: now.toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' }),
                    createdAt: serverTimestamp()
                });

                document.getElementById('dogWalkForm').reset();
                document.getElementById('previewContainer').classList.add('hidden');
                document.getElementById('uploadPrompt').classList.remove('hidden');
                document.getElementById('uploadForm').classList.add('hidden');
                switchTab('history');
            } catch (err) {
                alert("Error al subir. Intenta de nuevo.");
                console.error(err);
            } finally {
                btn.disabled = false;
                btn.innerText = "Confirmar Paseo";
            }
        };

        function renderHistory() {
            const container = document.getElementById('walksHistory');
            if (walks.length === 0) {
                container.innerHTML = `<div class="text-center py-20 bg-white rounded-3xl border border-dashed border-slate-200 text-slate-400"><i data-lucide="camera" class="mx-auto mb-2 opacity-20"></i>A煤n no hay fotos.</div>`;
            } else {
                container.innerHTML = walks.map(w => `
                    <div class="bg-white rounded-[2rem] overflow-hidden shadow-md border border-slate-100 fade-in">
                        <div class="relative h-80">
                            <img src="${w.image}" class="w-full h-full object-cover">
                            <div class="absolute bottom-4 left-4 right-4 flex justify-between items-end">
                                <div class="bg-white/95 backdrop-blur-md p-3 rounded-2xl shadow-xl border border-white">
                                    <p class="text-[10px] font-bold text-orange-600 uppercase tracking-tighter">${w.dateDisplay}</p>
                                    <div class="flex items-center gap-1 text-slate-900">
                                        <i data-lucide="clock" class="w-3 h-3 text-orange-500"></i>
                                        <span class="text-xl font-black">${w.timeDisplay}</span>
                                    </div>
                                </div>
                                <button onclick="window.delWalk('${w.id}')" class="bg-red-500/90 text-white p-4 rounded-2xl shadow-lg active:scale-75">
                                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>
                        <div class="p-5 font-medium italic text-slate-700">"${w.note}"</div>
                    </div>
                `).join('');
            }
            lucide.createIcons();
        }

        window.delWalk = async (id) => {
            if (confirm("驴Borrar foto?")) {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'walks', id));
            }
        };

        // 4. Navegaci贸n y Eventos Finales
        function switchTab(tab) {
            document.getElementById('scheduleSection').classList.toggle('hidden', tab !== 'schedule');
            document.getElementById('historySection').classList.toggle('hidden', tab !== 'history');
            document.getElementById('tabSchedule').className = tab === 'schedule' ? 'tab-active flex items-center gap-2 px-6 py-4 rounded-2xl transition-all' : 'tab-inactive flex items-center gap-2 px-6 py-4 rounded-2xl transition-all';
            document.getElementById('tabHistory').className = tab === 'history' ? 'tab-active flex items-center gap-2 px-6 py-4 rounded-2xl transition-all' : 'tab-inactive flex items-center gap-2 px-6 py-4 rounded-2xl transition-all';
            window.scrollTo(0, 0);
        }

        document.getElementById('tabSchedule').onclick = () => switchTab('schedule');
        document.getElementById('tabHistory').onclick = () => switchTab('history');
        document.getElementById('toggleFormBtn').onclick = () => {
            const f = document.getElementById('uploadForm');
            f.classList.toggle('hidden');
            document.getElementById('plusIcon').style.transform = f.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(45deg)';
        };
        document.getElementById('fileInput').onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                const r = new FileReader();
                r.onload = (ev) => {
                    document.getElementById('imagePreview').src = ev.target.result;
                    document.getElementById('previewContainer').classList.remove('hidden');
                    document.getElementById('uploadPrompt').classList.add('hidden');
                };
                r.readAsDataURL(file);
            }
        };
        document.getElementById('dogWalkForm').onsubmit = window.handleSave;

        // Iniciar todo
        startApp();

    </script>
</body>
</html>
